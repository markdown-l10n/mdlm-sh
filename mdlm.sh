#!/bin/bash

MDLM_VERSION="0.0.6"

IANA_TAG_DEFAULT="en|English|English"
# http://www.iana.org/assignments/language-subtag-registry/language-subtag-registry
IANA_TAGS_LIST="aa|Afaraf|Afar
ab|Аҧсуа|Abkhazian
ae|Avesta|Avestan
af|Afrikaans|Afrikaans
ak|Akan|Akan
am|አማርኛ|Amharic
an|Aragonés|Aragonese
ar|العَرَبِيَّة|Arabic
as|অসমীয়া|Assamese
av|Авар|Avaric
ay|Aymar|Aymara
az|Azərbaycanca|Azerbaijani
ba|Башҡорт|Bashkir
be|Беларуская|Belarusian
bg|Български|Bulgarian
bh|भोजपुरी|Bihari languages
bi|Bislama|Bislama
bm|Bamanankan|Bambara
bn|বাংলা|Bengali
bo|བོད་ཡིག|Tibetan
br|Brezhoneg|Breton
bs|Bosanski|Bosnian
ca|Català|Catalan
ce|Нохчийн|Chechen
ch|Chamoru|Chamorro
co|Corsu|Corsican
cr|Nehiyaw|Cree
cs|Česky|Czech
cu|Church Slavic|Church Slavic
cv|Чăваш|Chuvash
cy|Cymraeg|Welsh
da|Dansk|Danish
de|Deutsch|German
dv|ދިވެހި|Dhivehi
dz|རྫོང་ཁ|Dzongkha
ee|Eʋegbe|Ewe
el|Ελληνικά|Modern Greek (1453-)
en|English|English
eo|Esperanto|Esperanto
es|Español|Spanish
et|Eesti|Estonian
eu|Euskara|Basque
fa|فارسی|Persian
ff|Fulfulde|Fulah
fi|Suomi|Finnish
fj|Na Vosa Vakaviti|Fijian
fo|Føroyskt|Faroese
fr|Français|French
fy|Frysk|Western Frisian
ga|Gaeilge|Irish
gd|Gàidhlig|Scottish Gaelic
gl|Galego|Galician
gn|Avañe'ẽ|Guarani
gu|ગુજરાતી|Gujarati
gv|Gaelg|Manx
ha|هَوُسَ|Hausa
he|עברית|Hebrew
hi|हिन्दी|Hindi
ho|Hiri Motu|Hiri Motu
hr|Hrvatski|Croatian
ht|Kreyòl ayisyen|Haitian
hu|Magyar|Hungarian
hy|Հայերեն|Armenian
hz|Otjiherero|Herero
ia|Interlingua|Interlingua (International Auxiliary Language Association)
id|Bahasa Indonesia|Indonesian
ie|Interlingue|Interlingue
ig|Igbo|Igbo
ii|四川彝语|Sichuan Yi
ik|Iñupiak|Inupiaq
in|bahasa Indonesia|Indonesian
io|Ido|Ido
is|Íslenska|Icelandic
it|Italiano|Italian
iu|ᐃᓄᒃᑎᑐᑦ|Inuktitut
ja|日本語|Japanese
ji|Yiddish|Yiddish
jv|Basa Jawa|Javanese
ka|ქართული|Georgian
kg|KiKongo|Kongo
ki|Gĩkũyũ|Kikuyu
kj|Kuanyama|Kuanyama
kk|Қазақша|Kazakh
kl|Kalaallisut|Kalaallisut
km|ភាសាខ្មែរ|Khmer
kn|ಕನ್ನಡ|Kannada
ko|한국어|Korean
kr|Kanuri|Kanuri
ks|कश्मीरी|Kashmiri
ku|كوردی|Kurdish
kv|Коми|Komi
kw|Kernewek|Cornish
ky|Кыргызча|Kirghiz
la|Latina|Latin
lb|Lëtzebuergesch|Luxembourgish
lg|Luganda|Ganda
li|Limburgs|Limburgan
ln|Lingála|Lingala
lo|ລາວ|Lao
lt|Lietuvių|Lithuanian
lu|Luba-Katanga|Luba-Katanga
lv|Latviešu|Latvian
mg|Malagasy|Malagasy
mh|Kajin Majel|Marshallese
mi|Māori|Maori
mk|Македонски|Macedonian
ml|മലയാളം|Malayalam
mn|Монгол|Mongolian
mo|Moldovenească|Moldavian
mr|मराठी|Marathi
ms|Bahasa Melayu|Malay (macrolanguage)
mt|bil-Malti|Maltese
my|Myanmasa|Burmese
na|Dorerin Naoero|Nauru
nb|Norwegian Bokmål|Norwegian Bokmål
nd|Sindebele|North Ndebele
ne|नेपाली|Nepali (macrolanguage)
ng|Oshiwambo|Ndonga
nl|Nederlands|Dutch
nn|Norsk (nynorsk)|Norwegian Nynorsk
no|Norsk (bokmål / riksmål)|Norwegian
nr|isiNdebele|South Ndebele
nv|Diné bizaad|Navajo
ny|Chi-Chewa|Nyanja
oc|Occitan|Occitan (post 1500)
oj|ᐊᓂᔑᓈᐯᒧᐎᓐ|Ojibwa
om|Oromoo|Oromo
or|ଓଡ଼ିଆ|Oriya (macrolanguage)
os|Иронау|Ossetian
pa|ਪੰਜਾਬੀ|Panjabi
pi|Pāli|Pali
pl|Polski|Polish
ps|پښتو|Pushto
pt|Português|Portuguese
qu|Runa Simi|Quechua
rm|Rumantsch|Romansh
rn|Kirundi|Rundi
ro|Română|Romanian
ru|Русский|Russian
rw|Kinyarwandi|Kinyarwanda
sa|संस्कृतम्|Sanskrit
sc|Sardu|Sardinian
sd|सिनधि|Sindhi
se|Davvisámegiella|Northern Sami
sg|Sängö|Sango
sh|Srpskohrvatski|Serbo-Croatian
si|සිංහල|Sinhala
sk|Slovenčina|Slovak
sl|Slovenščina|Slovenian
sm|Gagana Samoa|Samoan
sn|chiShona|Shona
so|Soomaaliga|Somali
sq|Shqip|Albanian
sr|Српски|Serbian
ss|SiSwati|Swati
st|Sesotho|Southern Sotho
su|Basa Sunda|Sundanese
sv|Svenska|Swedish
sw|Kiswahili|Swahili (macrolanguage)
ta|தமிழ்|Tamil
te|తెలుగు|Telugu
tg|Тоҷикӣ|Tajik
th|ไทย|Thai
ti|ትግርኛ|Tigrinya
tk|Туркмен|Turkmen
tl|Tagalog|Tagalog
tn|Setswana|Tswana
to|Lea Faka-Tonga|Tonga (Tonga Islands)
tr|Türkçe|Turkish
ts|Xitsonga|Tsonga
tt|Tatarça|Tatar
tw|Twi|Twi
ty|Reo Mā\`ohi|Tahitian
ug|Uyƣurqə|Uighur
uk|Українська|Ukrainian
ur|اردو|Urdu
uz|Ўзбек|Uzbek
ve|Tshivenḓa|Venda
vi|Việtnam|Vietnamese
vo|Volapük|Volapük
wa|Walon|Walloon
wo|Wollof|Wolof
xh|isiXhosa|Xhosa
yi|ייִדיש|Yiddish
yo|Yorùbá|Yoruba
za|Cuengh|Zhuang
zh|简体中文|Chinese
zu|isiZulu|Zulu
az-Arab|آذربايجان|Azerbaijani in Arabic script
az-Cyrl|Aзәрбајҹан дили|Azerbaijani in Cyrillic script
az-Latn|Azərbaycanca|Azerbaijani in Latin script
be-Latn|Biełaruskaja|Belarusian in Latin script
bs-Cyrl|Босански|Bosnian in Cyrillic script
bs-Latn|Иosanski|Bosnian in Latin script
iu-Cans|ᐃᓄᒃᑎᑐᑦ|Inuktitut in Canadian Aboriginal Syllabic script
iu-Latn|Inuktitut|Inuktitut in Latin script
mn-Cyrl|Монгол|Mongolian in Cyrillic script
mn-Mong|Mongɣol|Mongolian in Mongolian script
sl-nedis|Nadiza dialect of Slovenian|Natisone dialect, Nadiza dialect
sl-rozaj|Rezijan dialect of Slovenian|Resian, Resianic, Rezijan
sr-Cyrl|Српски|Serbian in Cyrillic script
sr-Latn|Srpski|Serbian in Latin script
tg-Arab|تاجیکی|Tajik in Arabic script
tg-Cyrl|Тоҷикӣ|Tajik in Cyrillic script
uz-Cyrl|Ўзбек|Uzbek in Cyrillic script
uz-Latn|O‘zbekcha|Uzbek in Latin script
yi-Latn|Yidish|Yiddish, in Latin script
zh-cmn|官话|Mandarin Chinese
zh-cmn-Hans|官话|Mandarin Chinese (Simplified)
zh-cmn-Hant|官話|Mandarin Chinese (Traditional)
zh-gan|贛語|Kan or Gan
zh-Hans|简体中文|simplified Chinese
zh-Hans-CN|zh-Hans-CN|PRC Mainland Chinese in simplified script
zh-Hans-HK|zh-Hans-HK|Hong Kong Chinese in simplified script
zh-Hans-MO|zh-Hans-MO|Macao Chinese in simplified script
zh-Hans-SG|zh-Hans-SG|Singapore Chinese in simplified script
zh-Hans-TW|繁體中文|Taiwan Chinese in simplified script
zh-Hant|漢語|traditional Chinese
zh-Hant-CN|zh-Hant-CN|PRC Mainland Chinese in traditional script
zh-Hant-HK|zh-Hant-HK|Hong Kong Chinese in traditional script
zh-Hant-MO|zh-Hant-MO|Macao Chinese in traditional script
zh-Hant-SG|zh-Hant-SG|Singapore Chinese in traditional script
zh-Hant-TW|zh-Hant-TW|Taiwan Chinese in traditional script
zh-wuu|zh-wuu|Shanghaiese or Wu
zh-yue|粵語|Cantonese"

MDLM_HEADER="<!-- @l10n:h -->"
MDLM_P_OPEN="<!-- @l10n:p"
MDLM_P_CLOSE="@l10n:p -->"

normal=$'\e[0m'
bold=$(tput bold)
green=$(tput setaf 2)
red="$(tput setaf 1)"
yellow=$(tput setaf 3)
blue=$(tput setaf 6)

mdlm_echo() {
  command printf %s\\n "$*" 2>/dev/null
}

mdlm_version() {
  mdlm_echo ${MDLM_VERSION}
}

mdlm_list_locales() {
  local LOCALE_SEARCH="${1}"
  if [ -n "${LOCALE_SEARCH}" ]
  then
    mdlm_echo "${IANA_TAGS_LIST}" | grep -i "${LOCALE_SEARCH}" | awk -F\| '{print $1 " (" $2 ") " $3}'
  else
    mdlm_echo "${IANA_TAGS_LIST}" | awk -F\| '{print $1 " (" $2 ") - " $3}'
  fi
}

validate_locale() {
  local LOCALE="${1}"
  if [ -z "$LOCALE" ]
  then
    mdlm_echo
    mdlm_echo "Please specify locale."
    mdlm_echo "Exiting."
    exit 1
  fi
}

validate_args_count() {
  local MAX_ARGS_COUNT="${1}"
  shift
  if [ $# -gt ${MAX_ARGS_COUNT} ]
  then
    mdlm_echo
    mdlm_echo "Too many arguments provided."
    mdlm_echo "Exiting."
    exit 1
  fi
}

mdlm_add_locale() {
  local NEW_LOCALE="${1}"

  validate_locale $NEW_LOCALE

  local NEW_LOCALE_EXACT="^${NEW_LOCALE}[|]"
  local MATCHING_LOCALE="$(mdlm_list_locales ${NEW_LOCALE_EXACT} | head -n 1)"

  if [ ! -n "${MATCHING_LOCALE}" ]
  then
    mdlm_echo "No matching locales found: ${NEW_LOCALE}"
    exit 1
  fi 

  mdlm_echo "Creating new localization files."
  mdlm_echo

  command echo -n "Please confirm locale - \"${blue}${MATCHING_LOCALE}${normal}\" (yes): "
  read locale_confirmation
  if [ ! -z "$locale_confirmation" ] && [ ! "$locale_confirmation" = "yes" ] && [ ! "$locale_confirmation" = "y" ]
  then
    mdlm_echo
    mdlm_echo "Please choose another locale."
    mdlm_echo "Exiting."
    exit 1
  fi

  # Create localization files.
  local LOCALE_SUFFIX="$(echo ${MATCHING_LOCALE} | awk '{print $1}')"
  local LOCALE_DESCR="$(echo ${MATCHING_LOCALE} | awk '{print $2}' | sed -e 's/[()]//g')"

  local COUNT=0
  local MD_FILES="$(command find * -name "*.md" ! -name "*-[[:alnum:]]*.md" -print | sort)"
  for MD_FILE in ${MD_FILES}
  do
    local MD_FILE_LOCALE=$(echo $MD_FILE | sed -e "s/\./\-${LOCALE_SUFFIX}\./g")

    mdlm_echo
    command echo -n "Localize ${yellow}$MD_FILE${normal} (${yellow}${MD_FILE_LOCALE}${normal})? (yes): "
    read create_confirmation
    if [ ! -z "$create_confirmation" ] && [ ! "$create_confirmation" = "yes" ] && [ ! "$create_confirmation" = "y" ]
    then
      mdlm_echo "Skipped."
    else
      # TODO: if file exists, ask to override or skip.
      HEADER="$(grep "${MDLM_HEADER}" "${MD_FILE}")"
      command echo "${HEADER}" > ${MD_FILE_LOCALE}
      # TODO: replace @l10n hardcode with variable.
      command grep -v "${MDLM_HEADER}" ${MD_FILE} | awk -v RS="(^|\n)#" '{ if ($0) print "<!-- @l10n:p\n#" $0 "@l10n:p -->\nTBD\n"}' >> ${MD_FILE_LOCALE}
      COUNT=$((COUNT+1))
      mdlm_echo "Created."
    fi
  done

  mdlm_update_all_headers

  mdlm_echo
  mdlm_echo "Finished"
  mdlm_echo "Total files created: ${COUNT}"
}

mdlm_update_all_headers() {
  local MD_FILES="$(command find * -name "*.md" ! -name "*-[[:alnum:]]*.md" -print | sort)"
  for MD_FILE in ${MD_FILES}
  do
    MD_FILE_MASK="$(echo ${MD_FILE} | sed -e 's/\.md/\-*\.md/')"
    LOCALES_AVAILABLE="$(find * -wholename "${MD_FILE_MASK}" | sed -e 's/[^-]*-//' -e 's/\.md//')"
    if [ -n "${LOCALES_AVAILABLE}" ]
    then
      # Assemble header.
      DEFAULT_LOCALE_NAME="$(echo ${IANA_TAG_DEFAULT} | awk -F\| '{print $2}')"
      MD_FILE_TRIMMED="$(echo ${MD_FILE} | sed -e 's/.*\///g')"
      NEW_HEADER="[${DEFAULT_LOCALE_NAME}](${MD_FILE_TRIMMED})"
      for NEXT_LOCALE in ${LOCALES_AVAILABLE}
      do
        MD_FILE_LOCALE="$(echo ${MD_FILE_TRIMMED} | sed -e "s/\.md/\-${NEXT_LOCALE}.md/")"
        LOCALE_NAME="$(mdlm_list_locales "^${NEXT_LOCALE}[|]" | head -n 1 | awk '{print $2}' | sed -e 's/[()]//g')"
        NEXT_LOCALE_ENTRY="[${LOCALE_NAME}](${MD_FILE_LOCALE})"
        NEW_HEADER="${NEW_HEADER} | ${NEXT_LOCALE_ENTRY}"
      done

      NEW_HEADER="${NEW_HEADER} | *[Add](https:\/\/github.com\/markdown-l10n\/markdown-l10n-spec#workflow)* ${MDLM_HEADER}"

      # Apply header to all files.
      HEADER_EXISTS="$(grep -c "${MDLM_HEADER}" ${MD_FILE})"

      NEW_HEADER_DEFAULT="$(echo ${NEW_HEADER} | sed -e "s/\([^ ]*\)${MD_FILE_TRIMMED})/**\1${MD_FILE_TRIMMED})**/")"
      if [ ${HEADER_EXISTS} -eq 1 ]
      then
        command sed -i "s/.*${MDLM_HEADER}.*/${NEW_HEADER_DEFAULT}/" ${MD_FILE}
      else
        command sed -i "1 i\\${NEW_HEADER_DEFAULT}" ${MD_FILE}
      fi
      
      # TODO: reuse code for default and others.
      for NEXT_LOCALE in ${LOCALES_AVAILABLE}
      do
        MD_FILE_LOCALE="$(echo ${MD_FILE} | sed -e "s/\.md/\-${NEXT_LOCALE}.md/")"
        MD_FILE_LOCALE_TRIMMED="$(echo ${MD_FILE_LOCALE} | sed -e 's/.*\///g')"
        NEW_HEADER_LOCALE="$(echo ${NEW_HEADER} | sed -e "s/\([^ ]*\)${MD_FILE_LOCALE_TRIMMED})/**\1${MD_FILE_LOCALE_TRIMMED})**/")"
        HEADER_EXISTS="$(grep -c "${MDLM_HEADER}" ${MD_FILE_LOCALE})"
        if [ ${HEADER_EXISTS} -eq 1 ]
        then
          command sed -i "s/.*${MDLM_HEADER}.*/${NEW_HEADER_LOCALE}/" ${MD_FILE_LOCALE}
        else
          command sed -i "1 i\\${NEW_HEADER_LOCALE}" ${MD_FILE_LOCALE}
        fi
      done
      # end of TODO: reuse code for default and others.
    else
      command sed -i "/.*${MDLM_HEADER}.*/d" ${MD_FILE}
    fi
  done
}

mdlm_rm_locale() {
  local RM_LOCALE="${1}"

  validate_locale $RM_LOCALE

  # TODO: resue from add_locale()
  local RM_LOCALE_EXACT="^${RM_LOCALE}"
  local MATCHING_LOCALE="$(mdlm_list_locales ${RM_LOCALE_EXACT} | head -n 1)"

  if [ ! -n "${MATCHING_LOCALE}" ]
  then
    mdlm_echo "No matching locales found: ${RM_LOCALE}"
    exit 1
  fi 

  mdlm_echo "WARNING: Deleting localization files."
  mdlm_echo

  command echo -n "Please confirm locale - \"${blue}${MATCHING_LOCALE}${normal}\" (yes): "
  read locale_confirmation
  if [ ! -z "$locale_confirmation" ] && [ ! "$locale_confirmation" = "yes" ] && [ ! "$locale_confirmation" = "y" ]
  then
    mdlm_echo
    mdlm_echo "Please choose another locale."
    mdlm_echo "Exiting."
    exit 1
  fi

  local LOCALE_SUFFIX="$(echo ${MATCHING_LOCALE} | awk '{print $1}')"
  local LOCALE_DESCR="$(echo ${MATCHING_LOCALE} | awk '{print $2}' | sed -e 's/[()]//g')"
  # end of TODO: resue from add_locale()

  mdlm_echo
  mdlm_echo "List of files to delete:"
  RM_FILES_LIST="$(find * -name "*-${LOCALE_SUFFIX}.md")"
  mdlm_echo ${yellow}"${RM_FILES_LIST}"${normal}

  mdlm_echo
  command echo -n "Are you sure want to delete all files? (yes): "
  read delete_confirmation
  if [ ! -z "$delete_confirmation" ] && [ ! "$delete_confirmation" = "yes" ] && [ ! "$delete_confirmation" = "y" ]
  then
    mdlm_echo
    mdlm_echo "Cancelled."
    mdlm_echo "Exiting."
    exit 1
  fi
  
  command find * -name "*-${LOCALE_SUFFIX}.md" -exec rm '{}' \;

  mdlm_update_all_headers

  mdlm_echo "Localization files deleted."
}

mdlm_status() {
  local SHOW_DIFF="${1}"
  local ST_LOCALE="${2}"

  if [ -n "${ST_LOCALE}" ]
  then
    local MATCHING_LOCALE="$(mdlm_list_locales "^${ST_LOCALE}" | head -n 1)"
    if [ -n "${MATCHING_LOCALE}" ]
    then
      mdlm_echo "Localization status for: ${MATCHING_LOCALE}."
    else
      mdlm_echo "No match locale found: ${ST_LOCALE}. Localization status for all locales."
    fi
  else
    mdlm_echo "Localization status for all locales."
  fi

  local DIFF_COUNT=0

  local MD_FILES="$(command find * -name "*.md" ! -name "*-[[:alnum:]]*.md" -print | sort)"
  for MD_FILE in ${MD_FILES}
  do
    DEFAULT_LOCALE_NAME="$(echo ${IANA_TAG_DEFAULT} | awk -F\| '{print $2}')"
    mdlm_echo
    mdlm_echo "${yellow}${MD_FILE}${normal} (${DEFAULT_LOCALE_NAME}):"
    MD_FILE_MASK="$(echo ${MD_FILE} | sed -e 's/\.md/\-*\.md/')"
    LOCALES_AVAILABLE="$(find * -wholename "${MD_FILE_MASK}" | sed -e 's/[^-]*-//' -e 's/\.md//' | grep "${ST_LOCALE}")"

    if [ -n "${LOCALES_AVAILABLE}" ]
    then
      for NEXT_LOCALE in ${LOCALES_AVAILABLE}
      do
        MD_FILE_LOCALE="$(echo ${MD_FILE} | sed -e "s/\.md/\-${NEXT_LOCALE}.md/")"
        LOCALE_NAME="$(mdlm_list_locales "^${NEXT_LOCALE}[|]" | head -n 1 | awk '{print $2}' | sed -e 's/[()]//g')"
        
        # TODO: replace l10n hardcode with variable.
        OUTDATED_SECTIONS=$(diff --color -B <(grep -v "<!--[\ ]*@l10n:h[\ ]*-->" "${MD_FILE_LOCALE}" | sed -e '/@l10n:p -->/,/<!-- @l10n:p/d' -e '/<!-- @l10n:p/d') <(grep -v "${MDLM_HEADER}" "${MD_FILE}") | grep -v -e "[-<>]" | wc -l)
        if [ $OUTDATED_SECTIONS -gt 0 ]
        then
          STATUS="${red}outdated.${normal}"
          DIFF_COUNT=$((DIFF_COUNT+1))
        else
          STATUS="${green}synced.${normal}"
        fi
        mdlm_echo "* ${yellow}${MD_FILE_LOCALE}${normal} (${LOCALE_NAME}) - ${STATUS}"

        if [ ${SHOW_DIFF} -eq 1 ]
        then
        # TODO: replace l10n hardcode with variable.
          command diff --color -B <(grep -v "<!--[\ ]*@l10n:h[\ ]*-->" "${MD_FILE_LOCALE}" | sed -e '/@l10n:p -->/,/<!-- @l10n:p/d' -e '/<!-- @l10n:p/d') <(grep -v "${MDLM_HEADER}" "${MD_FILE}")
        fi
      done
    else
      mdlm_echo "- No localization"
    fi
  done

  if [ $DIFF_COUNT -eq 0 ]
  then
    return 0
  else
    return 2
  fi
}

mdlm_help() {
  MDLM_VERSION="$(mdlm version)"
  mdlm_echo "Markdown Localization Manager (v${MDLM_VERSION})"
  mdlm_echo "  mdlm help                 Show this message"
  mdlm_echo "  mdlm version              Print out the installed version of mdlm"
  mdlm_echo "  mdlm ls [<pattern>]       List all available locales, matching a given <pattern> if provided"
  mdlm_echo "  mdlm add <locale>         Create localization files for given <locale>"
  mdlm_echo "  mdlm rm <locale>          Remove all localization files for given <locale>"
  mdlm_echo "  mdlm status [<locale>]    Check synchronization status between original and localized versions, for a given <locale> if provided"
  mdlm_echo "    --diff                  Shows diff, if available."
}

mdlm() {
  if [ $# -lt 1 ]; then
    mdlm help
    return
  fi

  local COMMAND
  COMMAND="${1-}"
  shift

  case $COMMAND in
    "help" | "--help")
      mdlm_help
    ;;
    "version" | "--version")
      mdlm_version
    ;;
    "ls" | "list")
      validate_args_count 1 $@

      local LOCALE_SEARCH="${1}"
      mdlm_list_locales ${LOCALE_SEARCH}
    ;;
    "add")
      validate_args_count 1 $@

      local NEW_LOCALE="${1}"
      mdlm_add_locale ${NEW_LOCALE}
    ;;
    "rm")
      validate_args_count 1 $@

      local RM_LOCALE="${1}"
      mdlm_rm_locale ${RM_LOCALE}
    ;;
    "status")
      validate_args_count 2 $@

      local SHOW_DIFF=0
      local ST_LOCALE=""
      while [ $# -ne 0 ]
      do
        case "$1" in
          --diff)
            SHOW_DIFF=1
            shift
          ;;
          *)
            ST_LOCALE="$1"
            shift
          ;;
        esac
      done

      mdlm_status ${SHOW_DIFF} ${ST_LOCALE}
    ;;
    *)
      mdlm_echo "Unkown command: '${COMMAND}'"
      mdlm_echo
      mdlm_help
  esac
}

mdlm "$@"
